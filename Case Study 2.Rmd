---
title: "Case Study 2"
author: "Manuela Giansante & Lucia Camenisch"
date: "2023-03-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = "center")
```

```{r message=FALSE, warning= FALSE}
library(data.table)
library(pastecs)
library(dplyr)
library(corrplot)
library(naniar)
library(psych)
library(rcompanion) 
library(kableExtra)
library(caret)
library(REdaS)
```

```{r}
descriptions<- fread("Data File_Case Study_Factor Analysis_Variables.csv")
df<-read.csv("Data File_Case_Study_Factor Analysis_MD.csv")
```

```{r}
df1<-df[,c(9:41)]
vis_miss(df1) #qd22,26,28,29 misses some data
df1<-na.omit(df1)# remove them as she said to do
vis_miss(df1)
```
- how many are the requited case

```{r}
raqMatrix <- cor(df1)
corrplot(as.matrix(raqMatrix))
```

####  check whether the data set and all of its variables are suitable for factor analysis.
A strong correlation between two variables is most likely a signal of redundancy.
*from slides non molto ragionato* More precisely, there might be an underlying factor causing those variables to move the way that they move. A weaker correlation indicates that there are different factors affecting the variables.
We list below the variables displaying higher correlation:
```{r}
# which pairs?
high_cor<- findCorrelation(raqMatrix, cutoff = 0.75)
varnames <- colnames(df1)[high_cor]
pairs <- combn(varnames, 2)# to generate all possible pairs of the highly correlated variables
pairs <- t(pairs)
# you filter them
for (i in 1:nrow(pairs)) {
  corr <- cor(df1[,pairs[i,]])
  if (corr[1,2] > 0.75) {
    cat(paste(pairs[i,1], "and", pairs[i,2], "have a correlation of", corr[1,2], "\n"))
  }}
```


*copiato dall'esercizio in classe*
```{r}
KMOS(df1)

```

```{r}
bart_spher(df1)
```



#### Principal Component Analysis 1
```{r}
PC0 <- psych::principal(df1, 
                        rotate="varimax", scores=TRUE)

plot(PC0$values,xlab="Factor Number",ylab="Eigenvalue",main="Scree plot",cex.lab=1.2,cex.axis=1.2,cex.main=1.8)+abline(h=1)
```


```{r}
PC1 <- psych::principal(df1, 
                        rotate="varimax",
                        nfactors=7, 
                        scores=TRUE)
# i did 7 bc with 6 the loadings looked a mess
# i guess that the number of factors depends on how many dots are above the line
PC1_communalities=data.frame(sort(PC1$communality))
PC1_communalities %>% kbl()
```

#### total variance explained
*I honeslty have no clue where this is going sorry*
```{r}
EigenValue=PC1$values
Variance=EigenValue/ncol(subset(df1))*100
SumVariance=cumsum(EigenValue/ncol(subset(df1)))
Total_Variance_Explained=cbind(EigenValue=EigenValue[EigenValue>0],Variance=Variance[Variance>0],Total_Variance=SumVariance[Variance>0])
Total_Variance_Explained %>% kbl()
```


```{r}
print(PC1$loadings, cutoff=0.3,sort=TRUE)
# so here she looks at like the ones that are not in patterns
# than se confronts it with the communalities and from there she decides which ones to eliminate
```
qd26 low on rc7
qd7,qd8 low on rc5

#### principal analysis2 (for the last standing)
```{r}
# for now i put in just the ones that look out of pattern
PC2 <- psych::principal(subset(df1, select = c(qd1:qd6,qd9:qd25,qd27:qd33)), rotate="varimax", scores=TRUE)

plot(PC2$values,xlab="Factor Number",ylab="Eigenvalue",main="Scree plot",cex.lab=1.2,cex.axis=1.2,cex.main=1.8)+abline(h=1)
```


```{r}
#idk if we should changed the names
# maybe even find a function that does this on its own
EigenValue=PC2$values
Variance=EigenValue/ncol(subset(df1, select = c(qd1:qd6,qd9:qd25,qd27:qd33)))*100
SumVariance=cumsum(EigenValue/ncol(subset(df1, select = c(qd1:qd6,qd9:qd25,qd27:qd33))))
Total_Variance_Explained2=cbind(EigenValue=EigenValue[EigenValue>0],Variance=Variance[Variance>0],Total_Variance=SumVariance[Variance>0])
Total_Variance_Explained2
```
we try between 6 and 7 to see if the loadings look better
```{r}
PC3_6 <- psych::principal(subset(df1, select = c(qd1:qd6,qd9:qd25,qd27:qd33)), rotate="varimax",nfactors=6, scores=TRUE)
print(PC3_6$loadings, cutoff=0.3,sort=TRUE)
```
it does not look nice

```{r}
PC3_7 <- psych::principal(subset(df1, select = c(qd1:qd6,qd9:qd25,qd27:qd33)), rotate="varimax",nfactors=7, scores=TRUE)
print(PC3_7$loadings, cutoff=0.3,sort=TRUE)
```
*i honestly do not get why she did this, its literally pc2 called different, even tho for ours looks we might need to rethink how many we are taking away*
*do regression with factor scores???? do we even have a y?*


`

