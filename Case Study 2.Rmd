---
title: "Case Study 2"
author: "Manuela Giansante & Lucia Camenisch"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true # creating a table of contents (toc)
    toc_float:
      collapsed: false # toc does not collapse and is shown as a sidebar (toc_float)
    number_sections: true # document sections are numbered
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = "center")
```

```{r message=FALSE, warning= FALSE}
library(data.table)
library(naniar)          # vis_miss()
library(corrplot)        # corrplot()
library(caret)           # findCorrelation()
library(REdaS)           # KMOS()
library(tidyr)           # gather()
library(psych)           # principal()
library(kableExtra)      # kables for html
# library(pastecs)
# library(dplyr)
library(psych)
# library(rcompanion) 
library(kableExtra)
```

We start by loading both data files.

```{r}
descriptions <- fread("Data File_Case Study_Factor Analysis_Variables.csv")
df <- read.csv("Data File_Case_Study_Factor Analysis_MD.csv")
```

We select only the relevant columns which correspond to question numbers `qd1` to `qd33` inside `df`.

```{r}
df1 <- df[,c(9:41)]
```

We check for missing values.

```{r}
vis_miss(df1)
```

Since questions 22, 26, 28 and 29 contain missing values, we delete the corresponding rows.

```{r}
df1 <- na.omit(df1)
vis_miss(df1)
```

Now, our data frame `df1` has no more missing values.

**Lucia comment: what does this sentence mean?** - how many are the requited case

# Orthogonal Factor Analysis

## Inspect the correlation matrix.

```{r}
raqMatrix <- cor(df1)
corrplot(raqMatrix)
```

We can see some strong correlations, indicated by bigger and darker blue dots, between different questions. Furthermore, we notice that `qd4` and `qd23` seem to be the only two items with low correlations with all the other items. They are standalone items.

## Check whether the data set and all of its variables are suitable for factor analysis.

A strong correlation between two variables is most likely a signal of redundancy. *from slides non molto ragionato* More precisely, there might be an underlying factor causing those variables to move the way that they move. A weaker correlation indicates that there are different factors affecting the variables. We list below the variables displaying higher correlation:


```{r}
n = nrow(raqMatrix)
for (i in 1:(n-1)) {
  for (j in (i+1):n) {
    if (raqMatrix[i, j] >= 0.65) {
      print(paste(colnames(df1)[i],
                  "and",
                  colnames(df1)[j],
                  "have a correlation of",
                  round(raqMatrix[i, j], 2)))
    }
  }
}

rm(i, j, n)
```

```{r}
corrplot(raqMatrix, order = 'hclust', tl.cex = 0.8, addrect = 10)
```

```{r}
df1[, 1:9] %>% gather() %>%                 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_histogram() +
  theme_classic() +
  labs(title = "Histograms of questions 1 to 9")

df1[, 10:18] %>% gather() %>%                 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_histogram() +
  theme_classic() +
  labs(title = "Histograms of questions 10 to 18")

df1[, 19:27] %>% gather() %>%                 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_histogram() +
  theme_classic() +
  labs(title = "Histograms of questions 19 to 27")

df1[, 28:33] %>% gather() %>%                 
  ggplot(aes(value)) +
  facet_wrap(~ key, scales = "free") +
  geom_histogram() +
  theme_classic() +
  labs(title = "Histograms of questions 28 to 33")
```


*copiato dall'esercizio in classe*

```{r}
kmo = KMOS(df1)
kmo
sort(kmo$MSA)
```

```{r}
bart_spher(df1)
```

#### Principal Component Analysis 1

```{r}
PC0 <- principal(df1, rotate="varimax", scores=TRUE)

ggplot(mapping = aes(x = 1:33, y = PC0$values)) +
  geom_point(shape = 1, size = 2.5) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  theme_classic() +
  scale_x_continuous(breaks = seq(0, 33, 5)) +
  labs(x = "Factor Number",
       y = "Eigenvalue",
       title = "Scree plot")
```

We have 8 eigenvalues which are bigger than 1. Thus, we redo a principal components analysis with 8 factors.

```{r}
PC1 <- principal(df1, rotate="varimax", nfactors=8, scores=TRUE)
PC1_communalities=data.frame(sort(PC1$communality))
PC1_communalities %>% kbl()
```

#### total variance explained

*I honeslty have no clue where this is going sorry*

```{r}
EigenValue=PC1$values
Variance=EigenValue/ncol(subset(df1))*100
SumVariance=cumsum(EigenValue/ncol(subset(df1)))
Total_Variance_Explained=cbind(EigenValue=EigenValue[EigenValue>0],Variance=Variance[Variance>0],Total_Variance=SumVariance[Variance>0])
Total_Variance_Explained %>% kbl()
```

```{r}
print(PC1$loadings, cutoff=0.3,sort=TRUE)
# so here she looks at like the ones that are not in patterns
# than se confronts it with the communalities and from there she decides which ones to eliminate
```

qd26 low on rc7 qd7,qd8 low on rc5

#### principal analysis2 (for the last standing)

```{r}
# for now i put in just the ones that look out of pattern
PC2 <- psych::principal(subset(df1, select = c(qd1:qd6,qd9:qd25,qd27:qd33)), rotate="varimax", scores=TRUE)

plot(PC2$values,xlab="Factor Number",ylab="Eigenvalue",main="Scree plot",cex.lab=1.2,cex.axis=1.2,cex.main=1.8)+abline(h=1)
```

```{r}
#idk if we should changed the names
# maybe even find a function that does this on its own
EigenValue=PC2$values
Variance=EigenValue/ncol(subset(df1, select = c(qd1:qd6,qd9:qd25,qd27:qd33)))*100
SumVariance=cumsum(EigenValue/ncol(subset(df1, select = c(qd1:qd6,qd9:qd25,qd27:qd33))))
Total_Variance_Explained2=cbind(EigenValue=EigenValue[EigenValue>0],Variance=Variance[Variance>0],Total_Variance=SumVariance[Variance>0])
Total_Variance_Explained2
```

we try between 6 and 7 to see if the loadings look better

```{r}
PC3_6 <- psych::principal(subset(df1, select = c(qd1:qd6,qd9:qd25,qd27:qd33)), rotate="varimax",nfactors=6, scores=TRUE)
print(PC3_6$loadings, cutoff=0.3,sort=TRUE)
```

it does not look nice

```{r}
PC3_7 <- psych::principal(subset(df1, select = c(qd1:qd6,qd9:qd25,qd27:qd33)), rotate="varimax",nfactors=7, scores=TRUE)
print(PC3_7$loadings, cutoff=0.3,sort=TRUE)
```

*i honestly do not get why she did this, its literally pc2 called different, even tho for ours looks we might need to rethink how many we are taking away* *do regression with factor scores???? do we even have a y?*

\`

# Oblique Factor Analysis
